<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1"/>
<link rel="stylesheet" href="../stylesheets/style.css" />
<title>COMP 116: Introduction to Computer Security - Lab: Malware Analysis</title>
</head>

<body>
<h1>COMP 116: Introduction to Computer Security</h1>
<h2>Lab: Malware Analysis</h2>
<h2>Due: Tuesday, December 5th</h2>

<h4 class="note">This assignment is worth 10 points.  You must work on this assignment individually!</h4>

<h2>Objectives</h2>
<ol>
	<li>Analyze and reverse engineer a malicious Android app</li>
</ol>

<h2>Overview</h2>
<p>In this lab, you will analyze and reverse engineer a malicious Android app.  The point of malware analysis is to understand what the malware does.  The number of malicious Android apps is staggering.  "Every week or so, thereâ€™s a new form of Android malware discovered that works in a unique way from what's come before" [1].</p>

<h3>About Android Apps</h3>
<p>Java is the official programming language used to write Android apps.  An Android app is contained in an APK file (Android Package Kit).  An APK file is actually in ZIP format, an archive.  Provided an APK file, you can extract the contents of the app and decompile the app.</p>

<h3>Unzipping the APK file</h3>
<p>Unzipping the APK file via <code>unzip &lt;name_of_app.apk&gt;</code> will extract the following contents:</p>
<ul>
<li><code>AndroidManifest.xml</code> - contains app configuration details including app permissions, entry classes, API keys; not human readable</li>
<li><code>META-INF</code>  (directory) - information about the digital signature of the app</li>
<li>_<code>classes.dex</code> - a single file, compiled and assembled app code; not human readable</li>
<li><code>resources.arsc</code> - contains precompiled resources</li>
<li><code>res</code> (directory) - resources not compiled into <code>resources.arsc</code> including images, strings, and layouts</li>
</ul>

<h3>Tools: <code>dex2jar</code> and <code>JD-GUI</code></h3>
<p>One of the outputs of unzipping the contents of an APK file is <code>classes.dex</code>, compiled and assembled app code.  A <code>.dex</code> file is a compiled Android application code file.  Android programs are compiled into <code>.dex</code> (Dalvik Executable) files.  What does that mean?  Take a step back: Java programs are compiled to bytecode.  Generally speaking, bytecode is computer object code that is processed by a software known as a virtual machine (e.g., the Java VM or JVM).  This process is different than what happens when you compile a C/C++ program: a C/C++ program is compiled into machine code which an actual computer can understand and to be directly executed by the CPU.  Dalvik is the virtual machine for Android, not JVM.  Thus, <code>.dex</code> files contain bytecode.  Both bytecode and machine code are not human readable and are difficult to edit.  If you are familiar with Java, a .class file is analagous to a <code>.dex</code> file --with some notable differences [2].</p>

<p>You may be curious if it is possible to decompile the process: that is, reverse the compilation process from the <code>.dex</code> file to the high-level and readable <code>.java</code> file.  Yes it is possible but it may not be perfect.  You will need to use two tools: <code>dex2jar</code> to decompile the <code>.dex</code> file into a <code>.jar</code> file (a set of <code>.class</code> files), and then use <code>JD-GUI</code> to display Java source codes of <code>.class</code> files (that is, <code>.java</code> files).</code>

<ul>
<li><code>dex2jar</code> - <a href="https://github.com/pxb1988/dex2jar" target="_blank">https://github.com/pxb1988/dex2jar</a>
	<ul>
		<li><a href="https://stackoverflow.com/questions/5257830/how-to-use-dextojar" target="_blank">https://stackoverflow.com/questions/5257830/how-to-use-dextojar</a></li>
	</ul>
</li>
<li><code>JD-GUI</code> - <a href="http://jd.benow.ca/" target="_blank">http://jd.benow.ca/</a></li>
</ul>

<h3>Tool: <code>apktool</code></h3>
<p><code>apktool</code> is used to extract the contents of an APK file.  The contents can be edited.  <code>apktool</code> can also be used to rebuild a modified app.  As you can imagine, by modifying contents extracted from an APK file including adding new files, you can build a malicious version of the app.  The output of <code>apktool</code> will be a set of files:</code></p>

<ul>
	<li>A human readable version of the <code>AndroidManifest.xml</code> file</li>
	<li><code>smali</code> (directory)</li>
</ul>

<p>Of interest is the content in the <code>smali</code> directory.  Smali is an assembler for the DEX format used by Dalvik.  In other words, Smali is assembly code, more human readable.  There is a tool <code>baksmali</code> that takes in a <code>.dex</code> file as input and the output will be <code>.smali</code> files.</p>

<h2>Instructions</h2>

<p>Responses shall be written in a <code>README.md</code> file.</p>

<p>Download the following Android APK onto a Kali Linux VM: <a href="http://www.cs.tufts.edu/comp/116/app.apk">http://www.cs.tufts.edu/comp/116/app.apk</a>.  <strong>**WARNING: DO NOT INSTALL THIS APP ONTO YOUR PRIMARY ANDROID DEVICE!**</strong>  Answer the following questions:</p>

<p>1. Scan the APK file using VirusTotal.  What is the detection ratio as returned by VirusTotal?</p>

<p>2. Using <code>apktool</code> on Kali Linux, extract the contents of the APK file via <code>apktool d &lt;name_of_app.apk&gt;</code>.  Take a look at the <code>AndroidManifest.xml</code> file.  What permissions do the app have?  Does anything look peculiar?</code>

<p>3. Take a further look at the <code>AndroidManifest.xml</code> file, does anything happen when an SMS message is sent?   Does anything happen when the booting of phone is completed?  What are the names of the Java packages that are triggered when those actions happen?</p>

<p>4. Take a look at all the files in the resources folder <code>res</code>.  Are there any files look suspicious?</code>

<p>5. Are there any telephone numbers referenced in any of the files in the resources folder?  If so, what are the telephone numbers and in which files are the telephone numbers referenced in?</p>

<p>6. Go into the <code>smali</code> folder.  Find the Java packages that you listed in question 4.  Take a look at the packages' corresponding <code>.smali</code> files.  Are there any actions of interest?</code>

<p>7. Find and list all the HTTP and HTTPS URLs used in .smali files.  Send all the URLs to VirusTotal for analysis.  What is the VirusTotal detection ratio for each URL?</p>

<p>8. What does this app really do?  Provide a brief synopsis.  Show all evidence including lines of code in question, and cite any references.</p>

<h2>References</h2>
<ol>
<li><a href="https://www.rsaconference.com/writable/presentations/file_upload/mbs-r02-how-to-analyze-an-android-bot.pdf" target="_blank">https://www.rsaconference.com/writable/presentations/file_upload/mbs-r02-how-to-analyze-an-android-bot.pdf</a></li>
<li>If you are familiar with Java, you may be curious what's the difference between .class and .dex files: <a href="https://stackoverflow.com/questions/8210173/what-is-the-difference-between-class-and-dex-files" target="_blank">https://stackoverflow.com/questions/8210173/what-is-the-difference-between-class-and-dex-files</a></li>
</ol>

<h2>Submission</h2>
<p>Push your <code>README.md</code> file to your private repository that I created for you in a folder named <code>malware_analysis</code>.  Say that your private repository is named <code>comp116-mchow</code>, make sure your file is pushed to <code>comp116-mchow/malware_analysis</code>.</p>

</body>
</html>